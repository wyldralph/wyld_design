{{/* Auto Gallery Partial - Automatically creates a gallery from images in the project's images folder */}}
{{ $projectPath := .Page.File.Dir }}
{{ $imagesPath := printf "content/%simages" $projectPath }}
{{ $imageFiles := slice }}
{{ with readDir $imagesPath }}
  {{ $imageFiles = . }}
{{ end }}
{{ $validExtensions := slice ".jpg" ".jpeg" ".png" ".gif" ".webp" ".JPG" ".JPEG" ".PNG" ".GIF" ".WEBP" }}
{{ $images := slice }}
{{ range $imageFiles }}
  {{ if in $validExtensions (path.Ext .Name) }}
    {{ $images = $images | append . }}
  {{ end }}
{{ end }}
{{ if $images }}
  <section class="mb-12 w-full">
    <div class="grid gap-6 px-4 md:grid-cols-2 xl:grid-cols-3">
      {{ range $index, $image := $images }}
        <div
          class="overflow-hidden rounded-sm border border-gray-900/10 shadow-lg shadow-gray-900/10 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:shadow-gray-900/15"
        >
          <img
            src="{{ printf "/%simages/%s" $projectPath $image.Name }}"
            alt="Project gallery image"
            class="gallery-image h-72 w-full cursor-pointer object-cover select-none"
            loading="lazy"
            data-index="{{ $index }}"
            onclick="openLightbox({{ $index }})"
            draggable="false"
            oncontextmenu="return false"
          />
        </div>
      {{ end }}
    </div>
  </section>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 p-4">
    <div class="relative flex max-h-full max-w-full items-center justify-center">
      <img
        id="lightbox-image"
        src=""
        alt="Gallery image"
        class="max-h-[90vh] max-w-[90vw] object-contain transition-opacity duration-200 ease-out select-none"
        draggable="false"
        oncontextmenu="return false"
      />
      <button
        onclick="closeLightbox()"
        class="absolute -top-4 -right-4 flex h-10 w-10 items-center justify-center rounded-full bg-white text-black hover:bg-gray-200"
      >
        <span class="text-xl font-bold">&times;</span>
      </button>
    </div>
    <button
      id="prev-btn"
      onclick="prevImage()"
      class="fixed top-1/2 left-4 z-10 hidden -translate-y-1/2 rounded-lg bg-white/90 px-6 py-4 text-black shadow-lg transition-all duration-200 hover:bg-white hover:shadow-xl md:block"
    >
      <span class="text-2xl font-bold">&#8249;</span>
    </button>
    <button
      id="next-btn"
      onclick="nextImage()"
      class="fixed top-1/2 right-4 z-10 hidden -translate-y-1/2 rounded-lg bg-white/90 px-6 py-4 text-black shadow-lg transition-all duration-200 hover:bg-white hover:shadow-xl md:block"
    >
      <span class="text-2xl font-bold">&#8250;</span>
    </button>
  </div>

  <style>
    /* Additional image protection */
    .gallery-image,
    #lightbox-image {
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      pointer-events: auto;
    }

    /* Disable image context menu and selection */
    .gallery-image::selection,
    #lightbox-image::selection {
      background: transparent;
    }
  </style>

<script>
  const galleryImages = [{{ range $images }}"{{ printf "/%simages/%s" $projectPath .Name }}",{{ end }}];
  let currentImageIndex = 0;


  // Disable right-click on images specifically
  document.addEventListener('contextmenu', function(e) {
    if (e.target.classList.contains('gallery-image') || e.target.id === 'lightbox-image') {
      e.preventDefault();
      return false;
    }
  });

  // Disable drag and drop on images
  document.addEventListener('dragstart', function(e) {
    if (e.target.classList.contains('gallery-image') || e.target.id === 'lightbox-image') {
      e.preventDefault();
      return false;
    }
  });

  function openLightbox(index) {
    currentImageIndex = index;
    document.getElementById('lightbox-image').src = galleryImages[index];
    document.getElementById('lightbox').classList.remove('hidden');
    document.getElementById('lightbox').classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    document.getElementById('lightbox').classList.add('hidden');
    document.getElementById('lightbox').classList.remove('flex');
    document.body.style.overflow = 'auto';
  }

  function nextImage() {
    const img = document.getElementById('lightbox-image');
    img.style.opacity = '0';
    setTimeout(() => {
      currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
      img.src = galleryImages[currentImageIndex];
      img.style.opacity = '1';
    }, 100);
  }

  function prevImage() {
    const img = document.getElementById('lightbox-image');
    img.style.opacity = '0';
    setTimeout(() => {
      currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
      img.src = galleryImages[currentImageIndex];
      img.style.opacity = '1';
    }, 100);
  }

  document.getElementById('lightbox').addEventListener('click', function(e) {
    if (e.target === this) {
      closeLightbox();
    }
  });

  document.addEventListener('keydown', function(e) {
    if (!document.getElementById('lightbox').classList.contains('hidden')) {
      if (e.key === 'Escape') {
        closeLightbox();
      } else if (e.key === 'ArrowRight') {
        nextImage();
      } else if (e.key === 'ArrowLeft') {
        prevImage();
      }
    }
  });

  // Touch/swipe support for mobile with smooth natural scrolling
  let touchStartX = 0;
  let touchEndX = 0;
  let touchStartY = 0;
  let touchEndY = 0;
  let isSwipeInProgress = false;
  const minSwipeDistance = 50;
  const maxVerticalDistance = 100; // Prevent accidental vertical swipes

  document.getElementById('lightbox').addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
    isSwipeInProgress = false;
  }, { passive: true });

  document.getElementById('lightbox').addEventListener('touchmove', function(e) {
    // Prevent default only if it's a horizontal swipe
    const currentX = e.changedTouches[0].screenX;
    const currentY = e.changedTouches[0].screenY;
    const diffX = Math.abs(currentX - touchStartX);
    const diffY = Math.abs(currentY - touchStartY);

    if (diffX > diffY && diffX > 20) {
      e.preventDefault(); // Prevent default scrolling for horizontal swipes
      isSwipeInProgress = true;
    }
  }, { passive: false });

  document.getElementById('lightbox').addEventListener('touchend', function(e) {
    if (!isSwipeInProgress) return;

    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipe();
  }, { passive: true });

  function handleSwipe() {
    const swipeDistance = touchEndX - touchStartX;
    const verticalDistance = Math.abs(touchEndY - touchStartY);

    // Only process horizontal swipes that aren't too vertical
    if (Math.abs(swipeDistance) > minSwipeDistance && verticalDistance < maxVerticalDistance) {
      if (swipeDistance > 0) {
        // Swipe right - go to previous image
        prevImage();
      } else {
        // Swipe left - go to next image
        nextImage();
      }
    }
  }
</script>
{{ end }}
